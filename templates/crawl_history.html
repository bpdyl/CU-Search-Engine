{% extends "base.html" %}

{% block title %}Crawl History - Admin{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Page Header -->
    <div class="page-header">
        <nav style="margin-bottom: 1rem;">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('admin') }}">Admin</a></li>
                <li class="breadcrumb-item active">Crawl History</li>
            </ol>
        </nav>
        <h1 class="page-title"><i class="bi bi-clock-history" style="color: var(--primary-color);"></i> Crawl History</h1>
        <p class="page-description">View past crawler runs and their statistics</p>
    </div>

    <div class="row">
        <!-- Sidebar / Schedule Info -->
        <div class="col-12 col-lg-4" style="margin-bottom: 1.5rem;">
            <!-- Schedule Status Card -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header" style="background: var(--primary-color); color: white;">
                    <h3 class="card-title" style="color: white;"><i class="bi bi-calendar-check"></i> Crawl Schedule</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem;">
                        <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Status:</span>
                            {% if schedule_info.enabled %}
                                <span class="badge badge-success">Enabled</span>
                            {% else %}
                                <span class="badge badge-secondary">Disabled</span>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span style="color: var(--text-muted);">Interval:</span>
                            <strong>{{ schedule_info.interval_display }}</strong>
                        </div>
                    </div>

                    <hr style="border-color: var(--border-color);">

                    <!-- Next Crawl -->
                    <div style="text-align: center; padding: 1rem 0;">
                        <h4 style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 500;">Next Scheduled Crawl</h4>
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                            {% if schedule_info.is_overdue %}
                                <span style="color: var(--warning-color);">
                                    <i class="bi bi-exclamation-triangle"></i> Overdue
                                </span>
                            {% else %}
                                <span style="color: var(--primary-color);">{{ schedule_info.time_until_next }}</span>
                            {% endif %}
                        </div>
                        <small style="color: var(--text-muted);">{{ schedule_info.next_crawl_display }}</small>
                    </div>

                    <hr style="border-color: var(--border-color);">

                    <!-- Last Crawl -->
                    <div class="d-flex justify-content-between align-items-center">
                        <span style="color: var(--text-muted);">Last Crawl:</span>
                        <span>{{ schedule_info.last_crawl_display }}</span>
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="bi bi-bar-chart"></i> Crawl Statistics</h3>
                </div>
                <div class="card-body">
                    <div class="row" style="text-align: center;">
                        <div class="col-6" style="margin-bottom: 1rem;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">{{ stats.total_crawls }}</div>
                            <small style="color: var(--text-muted);">Total Crawls</small>
                        </div>
                        <div class="col-6" style="margin-bottom: 1rem;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">{{ stats.success_rate|round(0) }}%</div>
                            <small style="color: var(--text-muted);">Success Rate</small>
                        </div>
                        <div class="col-6">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info-color);">{{ stats.total_publications_discovered }}</div>
                            <small style="color: var(--text-muted);">New Pubs Found</small>
                        </div>
                        <div class="col-6">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);">{{ (stats.average_duration_seconds / 60)|round(1) }}m</div>
                            <small style="color: var(--text-muted);">Avg Duration</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content - History Table -->
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 class="card-title"><i class="bi bi-clock-history"></i> Crawl History</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <a href="{{ url_for('admin_crawl_summary') }}" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-graph-up"></i> Detailed Summary
                        </a>
                        <span class="badge badge-secondary">{{ history|length }} records</span>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Publications</th>
                                    <th>Trigger</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for crawl in history %}
                                <tr>
                                    <td>
                                        <div style="font-weight: 500;">{{ crawl.started_at[:10] }}</div>
                                        <small style="color: var(--text-muted);">{{ crawl.started_at[11:16] }}</small>
                                    </td>
                                    <td>
                                        {% set mins = crawl.duration_seconds // 60 %}
                                        {% set secs = crawl.duration_seconds % 60 %}
                                        {{ mins }}m {{ secs }}s
                                    </td>
                                    <td>
                                        {% if crawl.status == 'completed' %}
                                            <span class="badge badge-success">
                                                <i class="bi bi-check-circle"></i> Completed
                                            </span>
                                        {% elif crawl.status == 'completed_with_warnings' %}
                                            <span class="badge badge-warning">
                                                <i class="bi bi-exclamation-triangle"></i> Warnings
                                            </span>
                                        {% elif crawl.status == 'failed' %}
                                            <span class="badge badge-danger">
                                                <i class="bi bi-x-circle"></i> Failed
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ crawl.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if crawl.statistics %}
                                            <div>
                                                <span style="color: var(--success-color); font-weight: 600;">+{{ crawl.statistics.new_publications }}</span> new
                                            </div>
                                            <small style="color: var(--text-muted);">
                                                {{ crawl.statistics.publications_found }} total
                                            </small>
                                        {% else %}
                                            <span style="color: var(--text-muted);">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if crawl.trigger == 'scheduled' %}
                                            <span class="badge badge-info">
                                                <i class="bi bi-calendar"></i> Scheduled
                                            </span>
                                        {% elif crawl.trigger == 'manual' %}
                                            <span class="badge badge-secondary">
                                                <i class="bi bi-hand-index"></i> Manual
                                            </span>
                                        {% elif crawl.trigger == 'initial' %}
                                            <span class="badge badge-primary">
                                                <i class="bi bi-play-circle"></i> Initial
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ crawl.trigger }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary details-toggle"
                                                onclick="toggleDetails('details-{{ loop.index }}')">
                                            <i class="bi bi-chevron-down"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr class="details-row" id="details-{{ loop.index }}" style="display: none;">
                                    <td colspan="6" style="background: var(--bg-primary);">
                                        <div style="padding: 1rem;">
                                            <div class="row">
                                                <div class="col-12 col-md-6" style="margin-bottom: 1rem;">
                                                    <h4 style="color: var(--text-muted); margin-bottom: 0.75rem; font-size: 0.85rem; font-weight: 600;">Statistics</h4>
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        {% if crawl.statistics %}
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-person" style="color: var(--primary-color);"></i> Authors Crawled: {{ crawl.statistics.authors_crawled }}</li>
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-file-text" style="color: var(--info-color);"></i> Publications Found: {{ crawl.statistics.publications_found }}</li>
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-plus-circle" style="color: var(--success-color);"></i> New Publications: {{ crawl.statistics.new_publications }}</li>
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-arrow-repeat" style="color: var(--warning-color);"></i> Updated: {{ crawl.statistics.updated_publications }}</li>
                                                        <li><i class="bi bi-globe" style="color: var(--text-secondary);"></i> Pages Visited: {{ crawl.statistics.pages_visited }}</li>
                                                        {% else %}
                                                        <li style="color: var(--text-muted);">No statistics available</li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <h4 style="color: var(--text-muted); margin-bottom: 0.75rem; font-size: 0.85rem; font-weight: 600;">Details</h4>
                                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-hash"></i> ID: <code style="background: var(--bg-card); padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.75rem;">{{ crawl.id }}</code></li>
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-play"></i> Started: {{ crawl.started_at }}</li>
                                                        <li style="margin-bottom: 0.375rem;"><i class="bi bi-stop"></i> Completed: {{ crawl.completed_at }}</li>
                                                        <li>
                                                            <i class="bi bi-database"></i> Index Updated:
                                                            {% if crawl.index_updated %}
                                                                <span style="color: var(--success-color);">Yes</span>
                                                            {% else %}
                                                                <span style="color: var(--danger-color);">No</span>
                                                            {% endif %}
                                                        </li>
                                                    </ul>
                                                    {% if crawl.errors and crawl.errors|length > 0 %}
                                                    <h4 style="color: var(--text-muted); margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 600;">Errors/Warnings</h4>
                                                    <ul style="list-style: none; padding: 0; margin: 0; color: var(--warning-color);">
                                                        {% for error in crawl.errors %}
                                                        <li style="margin-bottom: 0.25rem;"><i class="bi bi-exclamation-circle"></i> {{ error }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
        <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Admin
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleDetails(id) {
    const row = document.getElementById(id);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
}
</script>
{% endblock %}

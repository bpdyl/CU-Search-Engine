{% extends "base.html" %}

{% block title %}Admin - Coventry Research Search{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <!-- Admin Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center" style="flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1 class="page-title"><i class="bi bi-gear" style="color: var(--primary-color);"></i> Administration</h1>
                <p class="page-description">Manage crawler, index, and classifier settings</p>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{{ url_for('admin_crawl_history') }}" class="btn btn-outline-primary">
                    <i class="bi bi-clock-history"></i> Crawl History
                </a>
                <a href="{{ url_for('admin_crawl_summary') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-graph-up"></i> Crawl Summary
                </a>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Crawler Section -->
        <div class="col-12 col-md-6" style="margin-bottom: 1.5rem;">
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <h3 class="card-title"><i class="bi bi-globe"></i> Web Crawler</h3>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Crawl publications from Coventry University's PURE Portal.
                    </p>
                    <form action="{{ url_for('run_crawler') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Maximum Authors to Crawl</label>
                            <input type="number" class="form-control" name="max_authors"
                                   value="20" min="1" max="100">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-play"></i> Start Crawler
                        </button>
                    </form>
                    <hr style="margin: 1.5rem 0; border-color: var(--border-color);">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;">Quick Actions</h4>
                    <form action="{{ url_for('load_sample_data') }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-download"></i> Load Sample Data
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Crawl Schedule Section -->
        <div class="col-12 col-md-6" style="margin-bottom: 1.5rem;">
            <div class="card" style="height: 100%;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="card-title"><i class="bi bi-calendar-check"></i> Crawl Schedule</h3>
                    <a href="{{ url_for('admin_crawl_history') }}" class="btn btn-sm btn-outline-secondary">
                        View History
                    </a>
                </div>
                <div class="card-body">
                    {% if schedule_info %}
                    <div class="row" style="text-align: center; margin-bottom: 1rem;">
                        <div class="col-6">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">{{ schedule_info.interval_display }}</div>
                            <small style="color: var(--text-muted);">Crawl Interval</small>
                        </div>
                        <div class="col-6">
                            <div style="font-size: 1.25rem; font-weight: 700;">
                                {% if schedule_info.enabled %}
                                    <span style="color: var(--success-color);"><i class="bi bi-check-circle"></i> Active</span>
                                {% else %}
                                    <span style="color: var(--text-muted);"><i class="bi bi-pause-circle"></i> Paused</span>
                                {% endif %}
                            </div>
                            <small style="color: var(--text-muted);">Status</small>
                        </div>
                    </div>
                    <hr style="margin: 1rem 0; border-color: var(--border-color);">
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-calendar-event" style="color: var(--primary-color);"></i>
                            <strong>Next Crawl:</strong>
                            {% if schedule_info.is_overdue %}
                                <span style="color: var(--warning-color);">Overdue</span>
                            {% else %}
                                {{ schedule_info.next_crawl_display }}
                            {% endif %}
                            <span class="badge badge-info">{{ schedule_info.time_until_next }}</span>
                        </li>
                        <li style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-clock-history" style="color: var(--text-muted);"></i>
                            <strong>Last Crawl:</strong> {{ schedule_info.last_crawl_display }}
                        </li>
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Index Section -->
        <div class="col-12 col-md-6" style="margin-bottom: 1.5rem;">
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <h3 class="card-title"><i class="bi bi-database"></i> Search Index</h3>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Manage the inverted index for search functionality.
                    </p>
                    <form action="{{ url_for('rebuild_index') }}" method="POST" style="margin-bottom: 1rem;">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-repeat"></i> Rebuild Index
                        </button>
                    </form>

                    {% if stats %}
                    <hr style="margin: 1rem 0; border-color: var(--border-color);">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;">Current Index Stats</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-file-text" style="color: var(--primary-color);"></i>
                            Documents: <strong>{{ stats.total_documents }}</strong>
                        </li>
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-hash" style="color: var(--success-color);"></i>
                            Unique Terms: <strong>{{ stats.total_terms }}</strong>
                        </li>
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-bar-chart" style="color: var(--info-color);"></i>
                            Avg Doc Length: <strong>{{ stats.average_doc_length }}</strong>
                        </li>
                        <li style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-calendar" style="color: var(--warning-color);"></i>
                            Last Updated: <strong>{{ stats.last_updated[:19] if stats.last_updated else 'Never' }}</strong>
                        </li>
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Classifier Section -->
        <div class="col-12 col-md-6" style="margin-bottom: 1.5rem;">
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <h3 class="card-title"><i class="bi bi-cpu"></i> Document Classifier</h3>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Train and manage the Naive Bayes document classifier.
                    </p>
                    <form action="{{ url_for('train_classifier') }}" method="POST" style="margin-bottom: 1rem;">
                        <button type="submit" class="btn btn-info">
                            <i class="bi bi-lightning"></i> Train Classifier
                        </button>
                    </form>

                    {% if classifier_info %}
                    <hr style="margin: 1rem 0; border-color: var(--border-color);">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;">Classifier Info</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-check-circle"></i> Status:
                            {% if classifier_info.status == 'Model loaded' %}
                                <span class="badge badge-success">Ready</span>
                            {% else %}
                                <span class="badge badge-warning">Not Trained</span>
                            {% endif %}
                        </li>
                        {% if classifier_info.accuracy is defined and classifier_info.accuracy != 'N/A' %}
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-graph-up" style="color: var(--success-color);"></i>
                            Accuracy: <strong>{{ (classifier_info.accuracy * 100)|round(1) }}%</strong>
                        </li>
                        {% endif %}
                        {% if classifier_info.total_samples is defined and classifier_info.total_samples != 'N/A' %}
                        <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-collection" style="color: var(--info-color);"></i>
                            Training Samples: <strong>{{ classifier_info.total_samples }}</strong>
                        </li>
                        {% endif %}
                        <li style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <i class="bi bi-tags" style="color: var(--primary-color);"></i> Categories:
                            {% for cat in classifier_info.categories %}
                                <span class="badge badge-secondary">{{ cat }}</span>
                            {% endfor %}
                        </li>
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- System Info Section -->
        <div class="col-12" style="margin-bottom: 1.5rem;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="bi bi-info-circle"></i> System Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-md-6" style="margin-bottom: 1rem;">
                            <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;">Technology Stack</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-code-slash" style="color: var(--primary-color);"></i>
                                    Framework: <strong>Flask</strong>
                                </li>
                                <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-box" style="color: var(--success-color);"></i>
                                    Search Engine: <strong>TF-IDF / BM25</strong>
                                </li>
                                <li style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-cpu" style="color: var(--info-color);"></i>
                                    Classifier: <strong>Multinomial Naive Bayes</strong>
                                </li>
                                <li style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="bi bi-translate" style="color: var(--warning-color);"></i>
                                    NLP: <strong>NLTK (Porter Stemmer, WordNet)</strong>
                                </li>
                            </ul>
                        </div>
                        <div class="col-12 col-md-6">
                            <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem;">Data Files</h4>
                            <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.85rem;">
                                <li style="margin-bottom: 0.375rem;">
                                    <code style="background: var(--bg-primary); padding: 0.125rem 0.375rem; border-radius: 4px;">data/publications.json</code>
                                    <span style="color: var(--text-muted);"> - Crawled publication data</span>
                                </li>
                                <li style="margin-bottom: 0.375rem;">
                                    <code style="background: var(--bg-primary); padding: 0.125rem 0.375rem; border-radius: 4px;">data/index.pkl</code>
                                    <span style="color: var(--text-muted);"> - Inverted search index</span>
                                </li>
                                <li style="margin-bottom: 0.375rem;">
                                    <code style="background: var(--bg-primary); padding: 0.125rem 0.375rem; border-radius: 4px;">data/classifier_model.pkl</code>
                                    <span style="color: var(--text-muted);"> - Trained classifier model</span>
                                </li>
                                <li style="margin-bottom: 0.375rem;">
                                    <code style="background: var(--bg-primary); padding: 0.125rem 0.375rem; border-radius: 4px;">data/crawl_history.json</code>
                                    <span style="color: var(--text-muted);"> - Crawl history records</span>
                                </li>
                                <li>
                                    <code style="background: var(--bg-primary); padding: 0.125rem 0.375rem; border-radius: 4px;">data/crawl_schedule.json</code>
                                    <span style="color: var(--text-muted);"> - Schedule configuration</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crawler Log -->
    {% if crawler_log %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="bi bi-terminal"></i> Crawler Log</h3>
        </div>
        <div class="card-body">
            <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: var(--radius-md); max-height: 400px; overflow-y: auto; margin: 0; font-size: 0.85rem;">{{ crawler_log }}</pre>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
